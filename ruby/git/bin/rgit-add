#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'rgit/object'
require 'fileutils'
require 'digest'
require 'zlib'

RGIT_DIR = '.rgit'.freeze

if !Dir.exist? RGIT_DIR
  $stderr.puts 'Not a rgit project'
  exit 1
end

path = ARGV.first

if path.nil?
  $stderr.puts 'No path specified'
  exit 1
end

if !File.exist?(path)
  $stderr.puts "'#{path}' file does not exist"    
  exit 1
end

file_content = File.read(path)
sha = Digest::SHA1.hexdigest file_content
blob = Zlib::Deflate.deflate file_content

object = RGit::Object.new(sha)
object.write do |file|
  file.print blob
end

File.open("#{RGIT_DIR}/index", 'a') do |file|
  file.puts "#{sha} #{path}"
end